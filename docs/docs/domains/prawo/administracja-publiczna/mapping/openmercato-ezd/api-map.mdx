---
title: Mapowanie API (CRUD)
sidebar_position: 60
---

Ten dokument opisuje minimalny zestaw endpointów CRUD dla MVP.

## Zasady

- Każda encja MVP ma standardowe operacje: list/get/create/update/delete.
- Dla list: paginacja, podstawowe filtrowanie, sortowanie.
- Brak procesów asynchronicznych w MVP.

## Proponowane zasoby

| Zasób | Endpoint (docelowy) | Uwagi |
|---|---|---|
| Kancelarie (Offices) | `/api/records/offices` | Jednostki organizacyjne zarządzające przesyłkami. Definiują zakres numeracji RPW i uprawnienia. |
| Przesyłki wpływające | `/api/records/incoming-shipments` | RPW jako numeracja na rekordzie (wykorzystuje generator analogiczny do `salesDocumentNumberGenerator` z zakresem per Kancelaria) |
| Dokumenty | `/api/records/documents` | dokument może istnieć sam |
| Koszulki | `/api/records/folders` | koszulka → sprawa 1:1 (patrz niżej) |
| Sprawy | `/api/records/cases` | nie inicjujemy automatycznie z przesyłki |
| Powiązania | `/api/records/record-links` | neutralne, symetryczne linki spraw/koszulek |
| Spisy spraw | `/api/records/case-registers` | numeracja spraw do dopięcia |
| JRWA | `/api/records/jrwa-classes` | drzewo klas |
| Lokalizacje składu | `/api/records/chronological-locations` | słownik |
| Historia lokalizacji | `/api/records/chronological-assignments` | historia przypisań dokument↔lokalizacja |
| Strony (Case Parties) | `/api/records/case-parties` | podmioty zaangażowane w sprawę; RBAC przez sprawę |

## Operacje „na granicy CRUD"

### Read-only (zamknięcie / otwarcie)

Sprawa może zostać ustawiona jako **read-only** (zamknięta). Read-only:

- blokuje edycję pól,
- blokuje dopinanie/odpinanie dokumentów,
- blokuje dodawanie/usuwanie powiązań.

Read-only jest odwracalne (reopen), ale wymaga dedykowanego uprawnienia (RBAC) — do ustalenia w module `records`.

W MVP traktujemy to jako standardowy `PATCH/PUT` na encji (`isReadOnly: true/false`).

### Powiązania (neutralne, symetryczne)

Powiązania są neutralne (bez typu/etykiety) i symetryczne.

W MVP:

- tworzenie: `POST /api/records/record-links`
- usuwanie: `DELETE /api/records/record-links/{id}`
- listowanie: `GET /api/records/record-links?type=case&id=<uuid>`

Walidacje:

- brak duplikatów A–B i B–A,
- A != B,
- jeśli dowolna strona jest read-only → brak zmian w powiązaniach.

## Przesyłka: oznaczenia odwzorowania

Zamiast statusów przesyłka posiada pola/flagę odwzorowania:

- rejestracja w składzie chronologicznym
- odwzorowanie pełne / częściowe

Te pola są aktualizowane przez standardowe `PATCH/PUT` na przesyłce.

## Dokumenty i załączniki

Dokument jest konceptualnie **załącznikiem z metadanymi**. Wykorzystuje moduł `attachments` (core) do zarządzania plikami.

### Endpointy dokumentów z załącznikami

Standardowe operacje CRUD na `/api/records/documents`:

- `POST /api/records/documents` – tworzenie dokumentu
  - Payload zawiera metadane dokumentu + opcjonalne `attachmentIds` (jeśli pliki były wcześniej uploadowane)
  - Alternatywnie: multipart/form-data z plikami + metadane w jednym request
- `GET /api/records/documents/{id}` – pobieranie metadanych dokumentu
  - Response zawiera `attachmentIds` z referencjami do plików
- `PATCH/PUT /api/records/documents/{id}` – aktualizacja metadanych i/lub załączników
  - Możliwość dodawania/usuwania załączników (przez zmianę `attachmentIds`)
  - Walidacja: jeśli dokument jest powiązany z encją `read-only`, blokujemy zmianę załączników
- `DELETE /api/records/documents/{id}` – usuwanie dokumentu
  - Polityka usuwania załączników do zdefiniowania (cascade delete lub orphan handling)

### Integracja z modułem `attachments`

Moduł `records` wykorzystuje standardowe endpointy modułu `attachments`:

- `POST /api/attachments` – upload pliku (zwraca `attachmentId`)
- `GET /api/attachments/{id}` – pobranie metadanych załącznika
- `GET /api/attachments/{id}/download` – download pliku
- `DELETE /api/attachments/{id}` – usuwanie pliku

### RBAC dla załączników

Dostęp do załączników dokumentu jest kontrolowany przez:

1. **Uprawnienia do głównego właściciela**:
   - Jeśli dokument powiązany z przesyłką → sprawdź uprawnienia do przesyłki
   - Jeśli dokument powiązany ze sprawą → sprawdź uprawnienia do sprawy (niezależnie od tego, czy ma przypisany znak sprawy)
   - Jeśli dokument samodzielny → sprawdź uprawnienia do dokumentu

2. **Poziom dostępu dokumentu** (`accessLevel`):
   - publiczny / częściowo / niepubliczny
   - Wpływa na widoczność załączników

3. **Status właściciela**:
   - Jeśli sprawa jest `read-only` → blokada modyfikacji załączników (dodawanie/usuwanie)
   - Odczyt załączników pozostaje dozwolony

Implementacja RBAC w module `records` musi zapewnić, że użytkownik pobierający załącznik przez `/api/attachments/{id}/download` ma odpowiednie uprawnienia do dokumentu i jego głównego właściciela.



## Kancelaria (Office): wielokancelaryjność i uprawnienia

### Operacje CRUD

Standardowe operacje na `/api/records/offices`:

- `POST /api/records/offices` – tworzenie nowej Kancelarii
- `GET /api/records/offices` – lista Kancelarii (z filtrowaniem po `isActive`)
- `GET /api/records/offices/{id}` – pobieranie szczegółów Kancelarii
- `PATCH/PUT /api/records/offices/{id}` – aktualizacja Kancelarii
- `DELETE /api/records/offices/{id}` – usuwanie Kancelarii (tylko jeśli brak powiązanych przesyłek)

### Konfiguracja numeracji RPW

Każda Kancelaria może mieć własny format numeracji RPW (`rpwNumberFormat`):

- Jeśli format jest pusty, używany jest domyślny: `"RPW/{YYYY}/{SEQ:6}"`
- Format wykorzystuje tokeny analogiczne do `salesDocumentNumberGenerator`:
  - `{YYYY}` – rok czterocyfrowy
  - `{YY}` – rok dwucyfrowy
  - `{MM}` – miesiąc dwucyfrowy
  - `{DD}` – dzień dwucyfrowy
  - `{SEQ:N}` – sekwencja z paddingiem (N cyfr)
  - `{RAND:N}` – losowe cyfry
  - `{NANOID:N}` – losowy identyfikator alfanumeryczny

Przykładowe formaty:
- `"RPW/{YYYY}/{SEQ:6}"` → RPW/2026/000001
- `"RPW-{CODE}/{YYYY}/{SEQ:4}"` → RPW-A/2026/0001 (gdzie {CODE} to kod Kancelarii)
- `"{YYYY}-{MM}/RPW-{SEQ:5}"` → 2026-01/RPW-00001

### Uprawnienia i RBAC

Dostęp do zasobów EZD jest kontrolowany przez przynależność do Kancelarii:

1. **Przypisanie pracownika do Kancelarii**:
   - Relacja N:M (pracownik może być w wielu Kancelariach)
   - Realizacja: `office_members` lub wykorzystanie RBAC z OpenMercato

2. **Kontrola dostępu**:
   - Użytkownik widzi tylko przesyłki/dokumenty z Kancelarii, do których jest przypisany
   - Dodatkowe filtry: poziom dostępu dokumentu, status sprawy (read-only)

3. **Role w Kancelarii** (do doprecyzowania):
   - Administrator Kancelarii (zarządza konfiguracją, użytkownikami)
   - Pracownik Kancelarii (obsługa przesyłek, edycja)
   - Czytelnik (tylko odczyt)

## RPW: numeracja z wykorzystaniem mechanizmów OpenMercato

### Generator numerów RPW

RPW wykorzystuje wzorzec analogiczny do `salesDocumentNumberGenerator`:

```typescript
interface RPWNumberGenerator {
  // Zakres numeracji
  scope: {
    organizationId: string
    tenantId: string
    officeId: string  // Nowy wymiar - per Kancelaria
  }
  
  // Generowanie numeru
  generate(): Promise<{
    rpwNumber: string      // Sformatowany numer
    rpwSequence: number    // Pozycja w sekwencji
    format: string         // Użyty format
  }>
  
  // Podgląd następnego numeru (bez zajmowania)
  peek(): Promise<number>
  
  // Ustawienie następnego numeru (np. po migracji)
  setNext(value: number): Promise<void>
}
```

### Implementacja

- **Tabela sekwencji**: `incoming_shipment_sequences` (analogicznie do `sales_document_sequences`)
  - Klucz: `(organization_id, tenant_id, office_id)`
  - Pole `current_value` z atomic increment
  - Obsługa concurrency przez `INSERT ... ON CONFLICT DO UPDATE`

- **Generowanie przy tworzeniu przesyłki**:
  - Automatyczne wywołanie generatora w `POST /api/records/incoming-shipments`
  - Pola `rpwNumber` i `rpwSequence` są tylko do odczytu (nie można ich edytować)

- **Endpoint diagnostyczny** (opcjonalnie):
  - `GET /api/records/offices/{id}/rpw-sequence` – podgląd następnego numeru
  - `POST /api/records/offices/{id}/rpw-sequence` – ustawienie następnego numeru (wymaga uprawnień administratora)

### Rejestracja chronologiczna

Pole `hasChronologicalRegistration: boolean` na przesyłce:

- Aktualizacja przez `PATCH /api/records/incoming-shipments/{id}`
- Proces:
  1. Przesyłka otrzymuje numer RPW przy utworzeniu (automatycznie)
  2. Rejestracja w składzie chronologicznym to osobny krok (ustawienie `hasChronologicalRegistration = true`)
  3. Opcjonalnie: przypisanie lokalizacji fizycznej (dla przesyłek papierowych)

## Strony (Case Parties): zarządzanie podmiotami sprawy

### Operacje CRUD

Standardowe operacje na `/api/records/case-parties`:

- `POST /api/records/case-parties` – dodanie strony do sprawy
  - Wymagane: `caseId`, `role`, `partyId` LUB `partyDisplayName`
  - Walidacja: jeśli sprawa jest `read-only` → błąd 403
- `GET /api/records/case-parties?caseId={uuid}` – lista stron sprawy
- `GET /api/records/case-parties/{id}` – szczegóły strony
- `PATCH/PUT /api/records/case-parties/{id}` – aktualizacja strony
  - Walidacja: jeśli sprawa jest `read-only` → błąd 403
- `DELETE /api/records/case-parties/{id}` – usunięcie strony
  - Walidacja: jeśli sprawa jest `read-only` → błąd 403

### RBAC dla stron

Dostęp do stron jest kontrolowany przez uprawnienia do sprawy:

- Użytkownik widzi strony tylko tych spraw, do których ma dostęp
- Poziom dostępu sprawy wpływa na widoczność stron
- Historia zmian stron jest zachowana (audit log)

### Integracja z rejestrem podmiotów

Strona może być powiązana z podmiotem z zewnętrznego rejestru:

- `partyId` → referencja do modułu `customers` (lub innego rejestru)
- Jeśli podmiot nie jest zarejestrowany → użyj `partyDisplayName` (ad-hoc)
- W przyszłości: możliwość "materializacji" ad-hoc strony jako pełnego podmiotu


## Search/indexer requirements (MVP)

W MVP wyszukiwanie Cmd+K ma obejmować tylko:

- **Sprawy**
- **Dokumenty**

Strategia search: **tokens**.

### Wymagania dla indeksowania (`query_index`)

CRUD dla `records.cases` i `records.documents` musi odświeżać indeks.

Checklist (implementacyjnie):

- Każdy CRUD route ma ustawiony `indexer: { entityType }`.
- `entityType` jest stabilnym identyfikatorem typu rekordu (np. `records:case`, `records:document` – do potwierdzenia konwencji).
- Po create/update/delete emitujemy side effects tak, aby rekord był widoczny w `tokens` search.

### Wymagania dla prezentacji wyników (`search.ts`)

Ponieważ `tokens` search renderuje wynik na podstawie konfiguracji w module search, moduł `records` musi dostarczyć presenter.

Checklist:

- Plik `search.ts` w module `records` zawiera wpisy dla `records:case` oraz `records:document`.
- Każdy wpis ma `formatResult` (title/subtitle/icon), aby uniknąć wyników w stylu „UUID”.
- (Opcjonalnie) `resolveUrl` kieruje do docelowej strony backend (gdy powstanie UI).
