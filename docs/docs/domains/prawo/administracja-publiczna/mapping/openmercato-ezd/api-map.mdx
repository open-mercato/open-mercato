---
title: Mapowanie API (CRUD)
sidebar_position: 60
---

Ten dokument opisuje minimalny zestaw endpointów CRUD dla MVP.

## Zasady

- Każda encja MVP ma standardowe operacje: list/get/create/update/delete.
- Dla list: paginacja, podstawowe filtrowanie, sortowanie.
- Brak procesów asynchronicznych w MVP.

## Proponowane zasoby

| Zasób | Endpoint (docelowy) | Uwagi |
|---|---|---|
| Przesyłki wpływające | `/api/records/incoming-shipments` | RPW jako numeracja na rekordzie |
| Dokumenty | `/api/records/documents` | dokument jako załącznik z metadanymi; może istnieć sam |
| Koszulki | `/api/records/folders` | koszulka → sprawa 1:1 (patrz niżej) |
| Sprawy | `/api/records/cases` | nie inicjujemy automatycznie z przesyłki |
| Powiązania | `/api/records/record-links` | neutralne, symetryczne linki spraw/koszulek |
| Spisy spraw | `/api/records/case-registers` | numeracja spraw do dopięcia |
| JRWA | `/api/records/jrwa-classes` | drzewo klas |
| Lokalizacje składu | `/api/records/chronological-locations` | słownik |
| Historia lokalizacji | `/api/records/chronological-assignments` | historia przypisań dokument↔lokalizacja |

## Operacje „na granicy CRUD"

### Read-only (zamknięcie / otwarcie)

Sprawa i koszulka mogą zostać ustawione jako **read-only** (zamknięte). Read-only:

- blokuje edycję pól,
- blokuje dopinanie/odpinanie dokumentów,
- blokuje dodawanie/usuwanie powiązań.

Read-only jest odwracalne (reopen), ale wymaga dedykowanego uprawnienia (RBAC) — do ustalenia w module `records`.

W MVP traktujemy to jako standardowy `PATCH/PUT` na encji (`isReadOnly: true/false`).

### Powiązania (neutralne, symetryczne)

Powiązania są neutralne (bez typu/etykiety) i symetryczne.

W MVP:

- tworzenie: `POST /api/records/record-links`
- usuwanie: `DELETE /api/records/record-links/{id}`
- listowanie: `GET /api/records/record-links?type=case|folder&id=<uuid>`

Walidacje:

- brak duplikatów A–B i B–A,
- A != B,
- jeśli dowolna strona jest read-only → brak zmian w powiązaniach.

## Przesyłka: oznaczenia odwzorowania

Zamiast statusów przesyłka posiada pola/flagę odwzorowania:

- rejestracja w składzie chronologicznym
- odwzorowanie pełne / częściowe

Te pola są aktualizowane przez standardowe `PATCH/PUT` na przesyłce.

## Dokumenty i załączniki

Dokument jest konceptualnie **załącznikiem z metadanymi**. Wykorzystuje moduł `attachments` (core) do zarządzania plikami.

### Endpointy dokumentów z załącznikami

Standardowe operacje CRUD na `/api/records/documents`:

- `POST /api/records/documents` – tworzenie dokumentu
  - Payload zawiera metadane dokumentu + opcjonalne `attachmentIds` (jeśli pliki były wcześniej uploadowane)
  - Alternatywnie: multipart/form-data z plikami + metadane w jednym request
- `GET /api/records/documents/{id}` – pobieranie metadanych dokumentu
  - Response zawiera `attachmentIds` z referencjami do plików
- `PATCH/PUT /api/records/documents/{id}` – aktualizacja metadanych i/lub załączników
  - Możliwość dodawania/usuwania załączników (przez zmianę `attachmentIds`)
  - Walidacja: jeśli dokument jest powiązany z encją `read-only`, blokujemy zmianę załączników
- `DELETE /api/records/documents/{id}` – usuwanie dokumentu
  - Polityka usuwania załączników do zdefiniowania (cascade delete lub orphan handling)

### Integracja z modułem `attachments`

Moduł `records` wykorzystuje standardowe endpointy modułu `attachments`:

- `POST /api/attachments` – upload pliku (zwraca `attachmentId`)
- `GET /api/attachments/{id}` – pobranie metadanych załącznika
- `GET /api/attachments/{id}/download` – download pliku
- `DELETE /api/attachments/{id}` – usuwanie pliku

### RBAC dla załączników

Dostęp do załączników dokumentu jest kontrolowany przez:

1. **Uprawnienia do głównego właściciela**:
   - Jeśli dokument powiązany z przesyłką → sprawdź uprawnienia do przesyłki
   - Jeśli dokument powiązany ze sprawą → sprawdź uprawnienia do sprawy
   - Jeśli dokument powiązany z koszulką → sprawdź uprawnienia do koszulki
   - Jeśli dokument samodzielny → sprawdź uprawnienia do dokumentu

2. **Poziom dostępu dokumentu** (`accessLevel`):
   - publiczny / częściowo / niepubliczny
   - Wpływa na widoczność załączników

3. **Status właściciela**:
   - Jeśli sprawa/koszulka jest `read-only` → blokada modyfikacji załączników (dodawanie/usuwanie)
   - Odczyt załączników pozostaje dozwolony

Implementacja RBAC w module `records` musi zapewnić, że użytkownik pobierający załącznik przez `/api/attachments/{id}/download` ma odpowiednie uprawnienia do dokumentu i jego głównego właściciela.

## Search/indexer requirements (MVP)

W MVP wyszukiwanie Cmd+K ma obejmować tylko:

- **Sprawy**
- **Dokumenty**

Strategia search: **tokens**.

### Wymagania dla indeksowania (`query_index`)

CRUD dla `records.cases` i `records.documents` musi odświeżać indeks.

Checklist (implementacyjnie):

- Każdy CRUD route ma ustawiony `indexer: { entityType }`.
- `entityType` jest stabilnym identyfikatorem typu rekordu (np. `records:case`, `records:document` – do potwierdzenia konwencji).
- Po create/update/delete emitujemy side effects tak, aby rekord był widoczny w `tokens` search.

### Wymagania dla prezentacji wyników (`search.ts`)

Ponieważ `tokens` search renderuje wynik na podstawie konfiguracji w module search, moduł `records` musi dostarczyć presenter.

Checklist:

- Plik `search.ts` w module `records` zawiera wpisy dla `records:case` oraz `records:document`.
- Każdy wpis ma `formatResult` (title/subtitle/icon), aby uniknąć wyników w stylu „UUID”.
- (Opcjonalnie) `resolveUrl` kieruje do docelowej strony backend (gdy powstanie UI).
