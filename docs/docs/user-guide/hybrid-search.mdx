---
title: Hybrid Search
description: Combine full-text fuzzy search, semantic vector search, and encrypted token search for comprehensive results.
---

The search module provides a unified hybrid search experience that combines multiple search strategies to deliver the best results. It automatically routes queries through configured backends and merges results using a re-ranking algorithm.

## Search Strategies

Open Mercato supports three complementary search strategies that work together:

| Strategy | Description | Best For |
|----------|-------------|----------|
| **Meilisearch** | Fast full-text fuzzy search with typo tolerance | Quick keyword lookups, partial matches |
| **Vector** | Semantic AI-powered search using embeddings | Conceptual queries, natural language |
| **Tokens** | Hash-based search for encrypted data | Always available, privacy-preserving |

When multiple strategies are configured, results are merged using Reciprocal Rank Fusion (RRF) to surface the most relevant matches.

## Prerequisites

### Meilisearch (Recommended)

Meilisearch provides the fastest and most user-friendly search experience with typo tolerance and instant results.

```bash
# Add to your .env
MEILISEARCH_HOST=http://localhost:7700
MEILISEARCH_API_KEY=your_master_key_here
```

Run Meilisearch locally with Docker:

```bash
docker run -d --name meilisearch \
  -p 7700:7700 \
  -e MEILI_ENV=development \
  -e MEILI_MASTER_KEY=your_master_key_here \
  getmeili/meilisearch:latest
```

### Vector Search (Optional)

Vector search enables semantic understanding of queries. See [Vector Search](/user-guide/vector-search) for embedding provider configuration.

### Token Search (Built-in)

Token-based search is always available and requires no additional configuration. It uses hashed tokens stored in PostgreSQL, making it suitable for encrypted data.

## How Results Are Ranked

When multiple strategies return results, the search module uses Reciprocal Rank Fusion (RRF) to combine them:

1. **Strategy weights**: Meilisearch (1.2x), Vector (1.0x), Tokens (0.8x)
2. **Duplicate handling**: When the same record appears in multiple results, the highest combined score wins
3. **Graceful degradation**: If a strategy fails (e.g., Meilisearch is down), others continue working

## What Gets Indexed

Modules define which entities are searchable via `search.ts` configuration files. The default installation includes:

- **Customers**: People and companies with names, titles, and contact info
- **Deals**: Deal names, stages, and descriptions
- **Activities**: Notes and activities linked to customers

## Encryption-Aware Field Filtering

The search module automatically protects sensitive data:

- **Searchable fields**: Safe to send to external providers (names, titles, descriptions)
- **Hash-only fields**: Indexed locally but never sent externally (emails, phones)
- **Excluded fields**: Never indexed (SSN, tax IDs, bank accounts)

Field policies are defined per entity in the module's `search.ts` configuration.

## Tenant Isolation

All search strategies enforce tenant isolation:

- **Meilisearch**: Separate indexes per tenant (prefixed with tenant ID)
- **Vector**: Filtered by tenant_id in queries
- **Tokens**: Scoped by tenant_id in the tokens table

## Configuration

The search module is enabled by default when you run `npm run modules:prepare`. Strategy availability depends on your environment:

| Environment Variable | Effect |
|---------------------|--------|
| `MEILISEARCH_HOST` | Enables Meilisearch strategy |
| `OPENAI_API_KEY` (or other embedding provider) | Enables Vector strategy |
| `OM_SEARCH_ENABLED=true` | Enables Token strategy (default: true) |

## Reindexing

When you first configure Meilisearch or change search configurations, existing records need to be indexed:

```bash
# Reindex all entities for a tenant
yarn mercato query_index reindex --tenant <tenantId>
```

Ongoing CRUD operations automatically update all search indexes via event subscribers.
