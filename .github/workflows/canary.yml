name: Canary Release

on:
  push:
    branches: [develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  canary:
    name: Publish Canary
    runs-on: ubuntu-latest
    # Only run on push to develop, or PRs from the same repo (not forks)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          echo "access=public" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Release canary
        id: release
        run: |
          ./scripts/release-canary.sh 2>&1 | tee release-output.txt

          # Build packages list from package.json files for PR comment
          PACKAGES_JSON=$(find packages -name package.json -not -path "*/node_modules/*" -exec cat {} \; | \
            jq -s '[.[] | select(.private != true) | {name: .name, version: .version}]')

          echo "packages_json<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          PACKAGE_COUNT=$(echo "$PACKAGES_JSON" | jq 'length')
          echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.release.outputs.package_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const packages = ${{ steps.release.outputs.packages_json }};

            let table = '| Package | Version |\n|---------|---------|';
            for (const pkg of packages) {
              table += `\n| \`${pkg.name}\` | \`${pkg.version}\` |`;
            }

            // Get a sample version for the install example
            const samplePkg = packages.find(p => p.name === '@open-mercato/shared') || packages[0];
            const sampleVersion = samplePkg?.version || 'VERSION';

            const body = `## Canary Release Published

            The following packages have been published to npm:

            ${table}

            ### Install

            \`\`\`bash
            npm install @open-mercato/shared@${sampleVersion}
            # or
            yarn add @open-mercato/shared@${sampleVersion}
            \`\`\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
