name: Snapshot Release

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

permissions:
  contents: read
  pull-requests: write

jobs:
  snapshot:
    name: Publish Snapshot
    outputs:
      snapshot_version: ${{ steps.release.outputs.version }}
    runs-on: ubuntu-latest
    # Skip PRs from forks (no access to secrets)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    env:
      YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          echo "access=public" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Determine release suffix
        id: suffix
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "value=canary" >> $GITHUB_OUTPUT
          else
            echo "value=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Release snapshot
        id: release
        run: |
          ./scripts/release-snapshot.sh "${{ steps.suffix.outputs.value }}"

          # Extract published version for downstream jobs
          echo "version=$(jq -r '.version' packages/shared/package.json)" >> $GITHUB_OUTPUT

          # Build packages list for PR comment
          PACKAGES_JSON=$(find packages -name package.json -not -path "*/node_modules/*" -exec cat {} \; | \
            jq -s '[.[] | select(.private != true) | {name: .name, version: .version}]')

          echo "packages_json<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          PACKAGE_COUNT=$(echo "$PACKAGES_JSON" | jq 'length')
          echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.release.outputs.package_count != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const packages = ${{ steps.release.outputs.packages_json }};
            const marker = '<!-- canary-release-comment -->';

            let table = '| Package | Version |\n|---------|---------|';
            for (const pkg of packages) {
              table += `\n| \`${pkg.name}\` | \`${pkg.version}\` |`;
            }

            const createAppPkg = packages.find(p => p.name === 'create-mercato-app');
            const createAppVersion = createAppPkg?.version || 'VERSION';

            const body = `${marker}
            ## Canary Release Published

            The following packages have been published to npm:

            ${table}

            ### Create a new app

            \`\`\`bash
            npx create-mercato-app@${createAppVersion} my-app
            \`\`\`
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  standalone-integration:
    name: Standalone App Integration Tests
    runs-on: ubuntu-latest
    needs: snapshot
    if: needs.snapshot.outputs.snapshot_version != ''
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: mercato
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: mercato_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # --- Monorepo setup (for test infrastructure) ---
      - name: Checkout monorepo
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Install monorepo dependencies
        run: yarn install --immutable

      - name: Build monorepo packages
        run: |
          yarn build:packages
          yarn generate
          yarn build:packages

      # --- Wait for npm propagation ---
      - name: Wait for npm registry propagation
        run: |
          VERSION="${{ needs.snapshot.outputs.snapshot_version }}"
          echo "Waiting for @open-mercato/shared@${VERSION} on npm..."
          for i in $(seq 1 30); do
            if npm view "@open-mercato/shared@${VERSION}" version 2>/dev/null; then
              echo "Available after attempt ${i}"
              exit 0
            fi
            echo "Attempt ${i}/30: waiting 10s..."
            sleep 10
          done
          echo "Package not available after 5 minutes"
          exit 1

      # --- Scaffold & build standalone app ---
      - name: Scaffold standalone app
        run: npx "create-mercato-app@${{ needs.snapshot.outputs.snapshot_version }}" /tmp/standalone-app

      - name: Configure standalone app environment
        working-directory: /tmp/standalone-app
        run: |
          cp .env.example .env
          cat >> .env << 'EOF'
          DATABASE_URL=postgres://mercato:secret@localhost:5432/mercato_test
          JWT_SECRET=ci-standalone-test-jwt-secret
          TENANT_DATA_ENCRYPTION_FALLBACK_KEY=ci-standalone-test-fallback-key
          NODE_ENV=test
          OM_TEST_MODE=1
          OM_TEST_AUTH_RATE_LIMIT_MODE=opt-in
          OM_DISABLE_EMAIL_DELIVERY=1
          ENABLE_CRUD_API_CACHE=true
          AUTO_SPAWN_WORKERS=false
          AUTO_SPAWN_SCHEDULER=false
          CACHE_STRATEGY=memory
          EOF

      - name: Install standalone app dependencies
        working-directory: /tmp/standalone-app
        run: yarn install

      - name: Generate standalone app modules
        working-directory: /tmp/standalone-app
        run: yarn generate

      - name: Initialize standalone app database
        working-directory: /tmp/standalone-app
        run: yarn initialize

      - name: Build standalone app
        working-directory: /tmp/standalone-app
        run: yarn build

      - name: Start standalone app
        working-directory: /tmp/standalone-app
        run: |
          PORT=3001 yarn start &
          echo "Waiting for standalone app to be ready..."
          for i in $(seq 1 90); do
            if curl -sf http://localhost:3001/login > /dev/null 2>&1; then
              echo "App ready after ${i}s"
              exit 0
            fi
            sleep 1
          done
          echo "App failed to start within 90s"
          exit 1

      # --- Run integration tests ---
      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run integration tests
        run: BASE_URL=http://localhost:3001 yarn test:integration

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: standalone-integration-results
          path: .ai/qa/test-results/
          if-no-files-found: ignore
