name: Snapshot Release

on:
  push:
    branches: [develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  snapshot:
    name: Publish Canary
    runs-on: ubuntu-latest
    # Only run on push to develop, or PRs from the same repo (not forks)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          echo "access=public" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create snapshot versions
        run: yarn changeset:snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish snapshot to npm
        id: publish
        run: |
          yarn changeset:publish-snapshot 2>&1 | tee publish-output.txt

          # Extract published packages and versions from output
          # Lines look like: ðŸ¦‹  info Publishing "@open-mercato/shared" at "0.4.1-canary-..."
          PACKAGES_JSON=$(grep 'Publishing "' publish-output.txt | \
            sed -E 's/.*Publishing "([^"]+)" at "([^"]+)".*/\1|\2/' | \
            jq -R -s 'split("\n") | map(select(length > 0)) | map(split("|")) | map({name: .[0], version: .[1]})' || echo "[]")

          echo "packages_json<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if any packages were published
          PACKAGE_COUNT=$(echo "$PACKAGES_JSON" | jq 'length')
          echo "package_count=$PACKAGE_COUNT" >> $GITHUB_OUTPUT
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.publish.outputs.package_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const packages = ${{ steps.publish.outputs.packages_json }};

            // Build markdown table
            let table = '| Package | Version |\n|---------|---------|';
            for (const pkg of packages) {
              table += `\n| \`${pkg.name}\` | \`${pkg.version}\` |`;
            }

            const body = `## Canary Release Published

            The following packages have been published to npm with the \`@canary\` tag:

            ${table}

            ### Install

            \`\`\`bash
            # Install a specific package
            npm install @open-mercato/shared@canary

            # Or with yarn
            yarn add @open-mercato/shared@canary
            \`\`\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
