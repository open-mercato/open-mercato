---
title: Feature Toggles
description: Manage feature availability across the application using global flags and granular overrides.
---

# Feature Toggles

## Overview

> [!IMPORTANT]
> **Required Role:** Super Admin only.

The **feature_toggles** module allows administrators to enable or disable features, modules, or specific functionality at runtime without code deployment. This provides operational flexibility for controlled rollouts, client-specific customizations, and emergency kill switches.

## Key Capabilities

-   **Hierarchical Resolution**: Resolves flags from specific tenant overrides up to global defaults.
-   **High Performance**: Uses aggressive caching with instant invalidation to minimize latency.
-   **Audit Trails**: Tracks all changes to toggles and overrides, supporting undo operations.
-   **Context Aware**: Designed to work seamlessly with multi-tenant architectures.

## Data Model

The feature toggles system is built around two primary entities that control feature availability.

### FeatureToggle

Defines the global state and behavior of a feature flag.

-   **`id`** (`uuid`): Unique identifier for the toggle.
-   **`identifier`** (`string`): The unique key used in code to check the feature (e.g., `checkout.new_flow`).
-   **`name`** (`string`): Human-readable name.
-   **`description`** (`string?`): Optional description of the feature.
-   **`category`** (`string?`): Optional grouping category.
-   **`defaultState`** (`boolean`): The global fallback state (enabled/disabled) used if no specific override matches.
-   **`failMode`** (`enum`): Determines behavior if the toggle cannot be retrieved from the database or cache.
    -   `fail_closed` (default): Defaults to disabled on error.
    -   `fail_open`: Defaults to enabled on error.

### FeatureToggleOverride

Allows granular control over a feature toggle for specific contexts.

-   **`id`** (`uuid`): Unique identifier for the override.
-   **`toggle`** (`relation`): Reference to the parent `FeatureToggle`.
-   **`tenantId`** (`uuid`): The tenant this override applies to.
-   **`state`** (`enum`): The specific state for this context (`enabled` or `disabled`).

> If no `FeatureToggleOverride` entity exists for a specific tenant, the system **inherits** the state from the `FeatureToggle.defaultState`.

## Caching Strategy

To ensure high performance and minimal latency, feature flag resolutions are heavily cached.

### Resolution Flow

1.  **Cache Check**: The system checks for a cached result using the key `feature_toggles:isEnabled:{identifier}:{tenantId}`.
2.  **Database Lookup (Toggle)**: If not cached, it fetches the `FeatureToggle` definition from the database.
3.  **Database Lookup (Override)**: It then checks for a `FeatureToggleOverride` matching the requested tenant.
4.  **Result Construction**: The final state is resolved (Override > Default State) and cached.

### Cache Tags & Invalidation

Cache entries are tagged to allow for precise invalidation when toggles or overrides are modified.

-   `feature_toggles:toggle:{identifier}`
-   `feature_toggles:tenant:{tenantId}`

### Configuration

The caching behavior is controlled by environment variables:

-   **`FEATURE_TOGGLES_CACHE_TTL_MS`**: Duration in milliseconds to cache valid resolution results (default: `60000` / 1 minute).
-   **`FEATURE_TOGGLES_ERROR_CACHE_TTL_MS`**: Duration in milliseconds to cache error states to prevent cascading failures (default: `10000` / 10 seconds).
-   **`FEATURE_TOGGLES_MISSING_TOGGLE_DEFAULT`**: Default boolean value returned when a toggle is completely missing from the system (default: `false`).

## Audit Logs

All modifications to feature toggles and overrides are audited to ensure accountability and traceability.

-   **Action Logs**: Creation, updates, deletions, and state changes are logged. The system supports **undo** operations for these actions, allowing you to revert changes quickly.
-   **Access Logs**: Read access to toggle overrides via the API is logged (`read:list`) to track who is verifying feature configurations.

## Using Feature Flags in the Frontend

### Component Wrapper

You can wrap components to conditionally render them based on feature availability using the `FeatureGuard` component.

```tsx
import { FeatureGuard } from '@open-mercato/core/modules/feature_toggles/components/FeatureGuard';

<FeatureGuard
  id="my.feature.key"
  fallback={<div className="alert">Feature disabled</div>}
  loadingFallback={<span>Loading...</span>}
>
  <MyFeatureComponent />
</FeatureGuard>
```

### useFeatureFlag Hook

For more logic-based control, use the `useFeatureFlag` hook.

```tsx
import { useFeatureFlag } from '@open-mercato/core/modules/feature_toggles/components/hooks/useFeatureFlag';

const MyComponent = () => {
  const { enabled, isLoading } = useFeatureFlag({ id: 'my_feature_key' });

  if (isLoading) return <div>Loading...</div>;
  if (!enabled) return null;

  return <div>Feature usage</div>;
};
```

## Server-Side Checks

In the backend, verify feature flags by resolving the `isFeatureEnabled` function from the dependency injection container. This ensures that all context (like database connections and extensive caching) is handled correctly.

```ts
import { createRequestContainer } from "@/lib/di/container";
import { IsFeatureEnabledFunction } from "@open-mercato/core/modules/feature_toggles/lib/feature-flag-check";

export async function GET(req: Request) {
    // ... authentication and context resolution ...

    const container = await createRequestContainer();
    const isFeatureEnabled = container.resolve('isFeatureEnabled') as IsFeatureEnabledFunction;
    
    const { enabled } = await isFeatureEnabled('my_feature_key', tenantId);

    if (enabled) {
        // Execute feature logic
    }
}
```

## Managing Feature Flags in the Admin

Manage your feature toggles through the Admin UI.

### Global Feature Toggles

View and manage all global feature flags.

![Global feature toggles view](/screenshots/open-mercato-feature-toggles-global-list.png)

### Editing a Feature Toggle

Update the status and details of a feature toggle.

![Edit feature toggle](/screenshots/open-mercato-feature-toggles-global-edit.png)

### Overrides

Configure specific overrides for feature toggles.

![Overrides in particular feature toggles](/screenshots/open-mercato-feature-toggles-overrides-list.png)